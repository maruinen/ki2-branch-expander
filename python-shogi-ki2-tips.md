# python-shogi & KI2 Parsing Tips

## 1. python-shogi の基本操作
- **局面の同一性判定**: SFEN文字列の「盤面配置」「手番」「持駒」の3要素をキーにする。
  ```python
  def get_board_key(board: shogi.Board) -> str:
      return " ".join(board.sfen().split(' ')[:3])
  ```
- **座標変換**: 1-basedの `(file, rank)` から内部インデックス（0-80）への変換。
  ```python
  # file=7, rank=6 (7六) -> index
  to_square = (rank - 1) * 9 + (9 - file)
  ```
- **駒の成り判定**: 内部定数を利用し、`actual_piece.piece_type + 8` が成駒のタイプに相当する。

## 2. KI2形式のパース
- **指し手の抽出**: 正規表現 `[▲△▽▼][^▲△▽▼
*]+` を用い、抽出後に `.strip()` することで、「同　歩」のような全角スペースを含む指し手もキャプチャ可能。
- **相対表記の処理**:
  - `同`: 直前の手の `to_square` を移動先とする。
  - `右/左/上/引/寄/直`: `board.legal_moves` から移動先が一致する候補を出し、移動元の座標（`from_square`）を比較して絞り込む。
- **変化（分岐）の処理**: 「変化：XX手」という行を見つけたら、メインラインの履歴から `XX-1` 手目の盤面を復元してシミュレーションを開始する。

## 3. ツリー探索と展開
- **循環参照（千日手）回避**: 再帰探索時に `path_history`（SFENの集合）を渡し、同一経路内での重複局面を検知して停止させる。
- **決定論的な出力**: `move_map`（局面 -> 指し手集合）から展開する際、指し手をUSI順などでソートしておくと、出力の再現性が確保できる。
