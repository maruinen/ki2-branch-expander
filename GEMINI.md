# GEMINI.md (Updated)

## 1. プロジェクトの目的
**Ki2 Branch Expander** は、合流した局面（同じ局面が異なる手順で現れる場合）を検出し、その局面から続く指し手をすべての経路に対して展開（複製）することで、再生アプリがグラフ表示（自動合流）をサポートしていなくても全分岐を表示可能にする。

## 2. 核心アーキテクチャ（2フェーズ・パス）
1.  **第一パス（収集）**: `extract_moves.py`
    - 元のKI2ファイルを走査し、すべての出現局面（SFENキー）とその局面から指された「次の手（USI形式）」の集合を構築。
    - メインラインだけでなく「変化：」で始まるすべての分岐を独立した手順としてシミュレートし、盤面状態の正確さを維持。
    - 相対表記（右、左、上、引、寄、直）を部分的にサポート。
2.  **第二パス（展開）**: `logic/expander.py`
    - 初期局面から `move_map` を用いて再帰的にツリーを構築。
    - 異なる手順でも同じ局面（SFEN）にたどり着けば、その局面以降のすべての分岐を再度展開。
    - 循環（千日手）は `path_history` により検出して停止。

## 3. 実装上の注意点
- **文字コード**: 出力は `cp932` (Shift_JIS) を推奨（将棋ソフトとの互換性のため）。
- **指し手のパース**: 指し手の抽出とパースを分離し、`legal_moves` から候補を絞り込む手法を採用。
- **デバッグ**: `Total moves found` と `Successfully parsed` の比率を監視し、パース失敗による盤面同期ずれを検知。

## 4. プログラム構成
- `main.py`: CLIエントリポイント。ファイルヘッダーの維持と複数ファイルのバッチ処理。
- `extract_moves.py`: KI2パーサーと局面ハッシュマップ生成。
- `logic/expander.py`: ツリー展開とKI2文字列生成（`get_ki2_move_str` を含む）。
