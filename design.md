# 設計詳細 (Design Document)

このドキュメントでは、Ki2 Branch Expander の核心となるアルゴリズムと内部データ構造について詳述します。

## データ構造

### 局面ハッシュマップ
- **構造**: `dict[str, set[shogi.Move]]`
- **キー**: 局面の SFEN 文字列（盤面、手番、持駒のみを抽出）。
- **値**: その局面から指されたことがある全ての「次の手」の集合。
- **目的**: 異なる経路から到達した同一局面において、既知のすべての分岐を網羅するために使用します。

## 処理プロセス

1. **第一パス（収集フェーズ）**
   - 入力 KI2 をパースし、出現するすべての局面と、そこから指された手をハッシュマップに記録します。
2. **第二パス（再構築フェーズ）**
   - ルート局面から再帰的に探索を開始します。
   - 各局面において、ハッシュマップに登録されている「すべての指し手」を分岐として書き出します。
   - **千日手対策**: 現在の探索パス（ルートからの局面履歴）を保持し、同一経路内で局面が重複した場合は、その指し手での探索を打ち切ります。

## 主要コンポーネント
- `extract_moves.py`: KI2 ファイルを走査し、局面ハッシュマップを構築する責務。
- `logic/expander.py`: ハッシュマップと `python-shogi` のシミュレーションを用いて、新しい指し手ツリーを再帰的に生成する責務。

詳細な使い方は [README.md](README.md) を参照してください。
